<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Hello.js</title>
        <meta name="description" content="">
        <meta name="theme-color" content="rgb(95, 18, 236)">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="manifest" href="./manifest.json">
        <link href="./css/material.min.css" rel="stylesheet" type="text/css" />
        <script src="./js/material.min.js"></script>
    </head>
    <body>
      <style>
        div#color-container * {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #color-container {
          padding: 4em 4em 6em;
          text-align: center;
          color: #f5f5f5;
        }
      </style>

      <div id="color-container">
        <form onsubmit="event.preventDefault();greet(event)">
          <span class="mdl-typography--display-3">Hello,</span>
          <div class="mdl-textfield mdl-js-textfield">
            <input type="text" class="mdl-textfield__input" value="tim.js" id="color-setter" />
          </div>
          <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect" style="margin-top: 2em; background: #f5f5f5">Greet me!</button>
        </form>
      </div>

      <div id="offline-ready" class="mdl-js-snackbar mdl-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
      </div>


      <div class="push-switch-container js-push-switch-container" style="margin: 3em auto 0;width: 250px;">
        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect js-push-toggle-switch" for="switch-2">
          <input type="checkbox" id="switch-2" class="mdl-switch__input" disabled>
          <span class="mdl-switch__label">Notifications, not alerts!</span>
        </label>
      </div>

      <script>
        function stringToColor(str) {
            // str to hash
            for (var i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));

            // int/hash to hex
            for (var i = 0, color = "#"; i < 3; color += ("00" + ((hash >> i++ * 8) & 0xFF).toString(16)).slice(-2));

            return color;
        }

        function greet(event) {
          alert('hello, ' + event.target[0].value + '!')
        }

        var container = document.getElementById('color-container');
        var themeColor = document.head.querySelector('meta[name="theme-color"]');
        var setter = document.getElementById('color-setter');

        var startValue = stringToColor(setter.value);

        container.style.backgroundColor = startValue;
        themeColor.content = startValue;

        setter.addEventListener('keyup', function(e) {
          var newColor = stringToColor(e.target.value);

          container.style.backgroundColor = newColor;
          themeColor.content = newColor;
        }, false);
      </script>

      <script>
        // SERVICE WORKERS
        if ('serviceWorker' in navigator) {
          var isPushEnabled = false;

          window.addEventListener('load', function() {
            var pushButton = document.querySelector('#switch-2');
            pushButton.addEventListener('change', function() {
              if (isPushEnabled) {
                unsubscribe();
              } else {
                subscribe();
              }
            });
          });

          navigator.serviceWorker.register('service-worker.js').then(function(reg) {
            // updatefound is fired if service-worker.js changes.
            reg.onupdatefound = function() {
              var installingWorker = reg.installing;

              installingWorker.onstatechange = function() {
                switch (installingWorker.state) {
                  case 'installed':
                    if (navigator.serviceWorker.controller) {
                      console.log('New or updated content is available.');
                    } else {
                      console.log('Content is now available offline!');

                      var snackbarContainer = document.querySelector('#offline-ready');
                      var data = {message: 'Content is now available offline!'};
                      snackbarContainer.MaterialSnackbar.showSnackbar(data);
                    }
                    break;

                  case 'redundant':
                    console.error('The installing service worker became redundant.');
                    break;
                }
              };
            };
          }).then(initialiseState).catch(function(e) {
            console.error('Error during service worker registration:', e);
          });



          // Once the service worker is registered set the initial state
          function initialiseState() {
            // Are Notifications supported in the service worker?
            if (!('showNotification' in ServiceWorkerRegistration.prototype)) {
              console.warn('Notifications aren\'t supported.');
              return;
            }

            // Check the current Notification permission.
            // If its denied, it's a permanent block until the
            // user changes the permission
            if (Notification.permission === 'denied') {
              console.warn('The user has blocked notifications.');
              return;
            }

            // Check if push messaging is supported
            if (!('PushManager' in window)) {
              console.warn('Push messaging isn\'t supported.');
              return;
            }

            // We need the service worker registration to check for a subscription
            navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
              // Do we already have a push message subscription?
              serviceWorkerRegistration.pushManager.getSubscription()
                .then(function(subscription) {
                  // Enable any UI which subscribes / unsubscribes from
                  // push messages.
                  var pushButton = document.querySelector('#switch-2');
                  pushButton.parentNode.MaterialSwitch.enable()

                  if (!subscription) {
                    // We aren't subscribed to push, so set UI
                    // to allow the user to enable push
                    return;
                  }

                  // Keep your server in sync with the latest subscriptionId
                  sendSubscriptionToServer(subscription);

                  // Set your UI to show they have subscribed for
                  // push messages
                  pushButton.textContent = 'Disable Push Messages';
                  isPushEnabled = true;
                })
                .catch(function(err) {
                  console.warn('Error during getSubscription()', err);
                });
            });
          }


function subscribe() {
  // Disable the button so it can't be changed while
  // we process the permission request
  var pushButton = document.querySelector('#switch-2');
  pushButton.parentNode.MaterialSwitch.disable()

  navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
    serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly: true})
      .then(function(subscription) {
        // The subscription was successful
        isPushEnabled = true;
        pushButton.textContent = 'Disable Push Messages';
        pushButton.disabled = false;

        // TODO: Send the subscription.endpoint to your server
        // and save it to send a push message at a later date
        return sendSubscriptionToServer(subscription);
      })
      .catch(function(e) {
        if (Notification.permission === 'denied') {
          // The user denied the notification permission which
          // means we failed to subscribe and the user will need
          // to manually change the notification permission to
          // subscribe to push messages
          console.warn('Permission for Notifications was denied');
          pushButton.parentNode.MaterialSwitch.disable()
        } else {
          // A problem occurred with the subscription; common reasons
          // include network errors, and lacking gcm_sender_id and/or
          // gcm_user_visible_only in the manifest.
          console.error('Unable to subscribe to push.', e);
          pushButton.parentNode.MaterialSwitch.enable()
          pushButton.textContent = 'Enable Push Messages';
        }
      });
  });
}

        }
      </script>
    </body>
</html>
